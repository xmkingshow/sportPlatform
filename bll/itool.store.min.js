
/*
 操作规范
 * 
 * 139939967@qq.com
 * 健健
 * 交流群：418967623
 * 
 * index 关键字 不一定等于 数组下标
 * 共有属性[date - length]
 * store(db.table).insert(date)
 * store(db.table).update(row,val,where)
 * store(db.table).select(where)
 * store(db.table).select(where).groupby(row)
 * store(db.table).select(where).orderby('row desc || asc')
 * */

(function(st){var db={createDateBase:function(name,fun){localStorage.setItem(name,JSON.stringify({createDateBase:new Date().getTime()}));if(fun)fun()},createTable:function(datebase,table,val,fun){var createParam=name.split('.');datebase=datebase;if(localStorage[datebase]){var DateBase=localStorage[datebase];var jsonDateBase=JSON.parse(DateBase);if(val){if(typeof val=='object'){if(val.push){jsonDateBase[table]=val}else{jsonDateBase[table]=[val]}}else if(typeof val=='string'){jsonDateBase[table]=[val]}}else{jsonDateBase[table]=[]}localStorage[datebase]=null;localStorage[datebase]=JSON.stringify(jsonDateBase);if(fun){fun()}}else{db.createDateBase(datebase,function(){db.createTable(datebase,table,val,fun)})}},newWhere:function(where){var whereArr=where.split(' ');whereArr[whereArr.length-1]='"'+whereArr[whereArr.length-1]+'"';where='';for(var i=0;i<whereArr.length;i++){var thisWhereStr=whereArr[i];switch(whereArr[i]){case'is':case'=':where+='== ';break;default:where+=thisWhereStr+' ';break}}return where},arrSoct:function(result,orderby){var orderByParam=orderby.split(' '),key=orderByParam[0];for(var j=1,jl=result.length;j<jl;j++){var temp=result[j],val=temp[key],i=j-1;while(i>=0&&result[i][key]>val){result[i+1]=result[i];i=i-1}result[i+1]=temp}if(orderByParam[1]&&orderByParam[1]=='desc'){return result.reverse()}return result},arrGroup:function(result,row){var arr=[],isArr=[];for(var i=0;i<result.length;i++){if(!result[i])return;var rowVal=eval('result[i].'+row);for(var j=0;j<result.length;j++){try{if(eval('rowVal == result[j].'+row))isArr.push(eval('result[i].'+row))}catch(e){}}if(isArr.length>0){arr.push({count:isArr.length,date:isArr[0]});isArr=[];i--}for(var j=0;j<result.length;j++){if(eval('rowVal == result[j].'+row)){result.splice(j,1);j--}}}return arr}};this.fn=this.prototype={init:function(dateBaseTable){var dateBaseParam=dateBaseTable.split('.');if(dateBaseParam.length>1){this.datebase='_a_b_c_d_'+dateBaseParam[0];this.table=dateBaseParam[1]}else{this.datebase='_a_b_c_d_';this.table=dateBaseParam[0]}}};this.fn.init.prototype=this.fn;this.extend=this.fn.extend=function(obj,prop){if(!prop){prop=obj;obj=this}for(var o in prop){obj[o]=prop[o]}};this.fn.extend({insert:function(val){var self=this;if(localStorage[this.datebase]){var DateBase=localStorage[this.datebase];var jsonDateBase=JSON.parse(DateBase);if(val){if(jsonDateBase&&jsonDateBase[this.table]){console.log('insert',typeof val)if(typeof val=='object'){if(val.push){for(var n=0;n<val.length;n++){val[n].index=jsonDateBase[this.table].length;jsonDateBase[this.table].push(val[n])}}else{val.index=jsonDateBase[this.table].length;jsonDateBase[this.table].push(val)}}else if(typeof val=='string'){jsonDateBase[this.table].push(val)}this.date=jsonDateBase;this.length=this.date.length;localStorage[this.datebase]=JSON.stringify(jsonDateBase)}else{console.log('insert createTable')db.createTable(this.datebase,this.table,false,function(){self.insert(val)})}}}else{console.log('insert createDateBase')db.createDateBase(this.datebase,function(){self.insert(val)})}return this},update:function(row,val,where){this.length=0;if(localStorage[this.datebase]){var DateBase=localStorage[this.datebase];var jsonDateBase=JSON.parse(DateBase);if(jsonDateBase[this.table]){var tableDate=jsonDateBase[this.table];if(where){where=db.newWhere(where)}else{return alert('条件不可未空')}for(var n=0;n<tableDate.length;n++){try{var accord=eval("tableDate[n]."+where);console.log(accord,where)if(accord){eval("tableDate[n]."+row+" = '"+val+"'");this.length++}}catch(e){}}this.date=jsonDateBase;localStorage[this.datebase]=JSON.stringify(jsonDateBase)}}return this},delete:function(where){this.length=0;if(localStorage[this.datebase]){var DateBase=localStorage[this.datebase];var jsonDateBase=JSON.parse(DateBase);if(jsonDateBase[this.table]){var tableDate=jsonDateBase[this.table];if(where){where=db.newWhere(where)}else{return alert('条件不可未空')}for(var n=0;n<tableDate.length;n++){try{var accord=eval("tableDate[n]."+where);console.log(accord,where)if(accord){tableDate.splice(n,1);this.length++}}catch(e){}}this.date=jsonDateBase;localStorage[this.datebase]=JSON.stringify(jsonDateBase)}}return this},select:function(where){var ret=[];if(localStorage[this.datebase]){var DateBase=localStorage[this.datebase];var jsonDateBase=JSON.parse(DateBase);if(jsonDateBase[this.table]){var tableDate=jsonDateBase[this.table];if(where){where=db.newWhere(where);for(var n=0;n<tableDate.length;n++){try{var accord=eval("tableDate[n]."+where);if(accord){ret.push(tableDate[n])}}catch(e){}}}else{ret=tableDate}}}this.date=ret;this.length=this.date.length;return this},orderby:function(val){this.date=db.arrSoct(this.date,val);this.length=this.date.length;return this},groupby:function(val){this.date=db.arrGroup(this.date,val);this.length=this.date.length;return this}});if(window.ITOOL){window.ITOOL.store=window.IT.store=window.itool.store=window.store}})(window.store=function(obj){if(!obj){return alert('请输入存储名称')}return new this.fn.init(obj)});